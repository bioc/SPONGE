---
title: "spongeEffects.Rmd"
author: "Hoffmann M"
date: "2/10/2022"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## (A) Loading dependencies for spongEffects

We start with loading the package and its dependencies

```{r, warning=FALSE, message=FALSE}
library(SPONGE)
library(doParallel)
library(foreach)

num.of.cores <- 25 #many more on a compute cluster
cl <- makeCluster(num.of.cores) 
registerDoParallel(cl)
```

## (B) prepare TCGA data
```{r, warning=FALSE, message=FALSE}

load("/nfs/data/TCGA_TGCT/spongEffects_package/spongeEffects/Data/TCGA_Expression_Data/breast invasive carcinoma.RData")
tcga_clinical<-read.delim("/nfs/data/TCGA_TGCT/spongEffects_package/spongeEffects/Data/Metadata/BRCA_data_clinical_patient.txt", comment.char="#")

tcga_tumor_stages=c('STAGE I', 'STAGE IA', 'STAGE IB', 'STAGE II', 'STAGE IIA', 'STAGE IIB', 'STAGE III', 'STAGE IIIA', 'STAGE IIIB', 'STAGE IIIC', 'STAGE IV')
tcga_subtypes=c("LumA",  "LumB",  "Her2",  "Basal", "Normal")
prep_list_tcga_spongEffects<-prepare_tcga_for_spongEffects(tcga_cancer_symbol = "BRCA",normal_ceRNA_expression_data = normal_gene_expr, tumor_ceRNA_expression_data = cancer_gene_expr, normal_metadata = normal_meta_data, tumor_metadata = cancer_meta_data,clinical_data = tcga_clinical, tumor_stages_of_interest = tcga_tumor_stages, subtypes_of_interest = tcga_subtypes)
```

## (C) prepare METABRIC data

```{r, warning=FALSE, message=FALSE}
tcga_subtypes=c("LumA",  "LumB",  "Her2",  "Basal", "Normal")
prep_list_METABRIC_spongEffects<-prepare_metabric_for_spongEffects(metabric_expression = "/nfs/data/TCGA_TGCT/spongEffects_package/spongeEffects/Data/Validation/brca_metabric/data_expression_median.txt",metabric_metadata = "/nfs/data/TCGA_TGCT/spongEffects_package/spongeEffects/Data/Validation/brca_metabric/data_clinical_patient.txt",subtypes_of_interest = tcga_subtypes, bioMart_gene_ensembl = "hsapiens_gene_ensembl", bioMart_gene_symbol_columns = "hgnc_symbol")

```

## (D) filter ceRNA network

```{r message=FALSE, warning=FALSE}
#load data from SPONGEdb
load("/nfs/data/TCGA_TGCT/spongEffects_package/spongeEffects/Data/Sponge_Networks/breast invasive carcinoma_sponge_results.RData")
Node.Centrality <- read.csv("/nfs/data/TCGA_TGCT/spongEffects_package/spongeEffects/Data/NetworkAnalysis/breast_invasive_carcinoma_networkAnalysis.csv", sep = " ")

#filter ceRNA network and calculate weighted node centralities

filtered_network_centralities=filter_ceRNA_network(sponge_effects = sponge_effects, network_analysis = Node.Centrality, mscor.threshold = 0.1, padj.threshold = 0.01)

```

## (E) discover lncRNA modules
```{r, warning=FALSE, message=FALSE}

lncRNA_modules<-get_central_modules(bioMart_gene_ensembl = "hsapiens_gene_ensembl", weighted_node_centrality = filtered_network_centralities$Node.Centrality, cutoff = 750)

```

## (F) Define Modules
```{r, warning=FALSE, message=FALSE}

Sponge.modules <- define_modules(network = filtered_network_centralities$Sponge.filtered, central.modules = lncRNA_modules, remove.central = T, set.parallel = F)
# Module size distribution
Size.modules <- sapply(Sponge.modules, length)

```

## (G) [TCGA] calculate Enrichment Scores (OE)
```{r, warning=FALSE, message=FALSE}

#Possible methods: "OE" (OverallEnrichment), "GSVA" (Gene Set Variation Analysis), "ssGSEA" #(single-sample gene set ernichment analysis)
#We used OE in our Boniolo et al., 2022

#We also accept multi threading here. Default is 1 core.

#sponge_effects<-NULL

BRCA.Modules.OE <- enrichment_modules(Expr.matrix = prep_list_tcga_spongEffects$TCGA.expr.tumor, modules = Sponge.modules, bin.size = 100, min.size = 10, max.size = 200,min.expr = 10, method = "OE")

```

## (H)[METABRIC] calculate Enrichment Scores (OE)
```{r, warning=FALSE, message=FALSE}
METABRIC.Modules.OE <- enrichment_modules(Expr.matrix= prep_list_METABRIC_spongEffects$METABRIC.expr, modules = Sponge.modules, bin.size = 100, min.size = 10, max.size = 200, method = "OE")

```

## (I) Calculate Enrichment Scores (GSVA) if you want to compare enrichment scores
```{r, warning=FALSE, message=FALSE}
BRCA.Modules.GSVA <- enrichment_modules(Expr.matrix= prep_list_tcga_spongEffects$TCGA.expr.tumor,modules = Sponge.modules, bin.size = 100, min.size = 10,max.size = 200, method = "GSVA")

METABRIC.Modules.GSVA <- enrichment_modules(prep_list_METABRIC_spongEffects$METABRIC.expr,modules =Sponge.modules, bin.size = 100, min.size = 10,max.size = 200, method = "GSVA")

```
## (J) 1. Train and test random forests
```{r, warning=FALSE, message=FALSE}
#I DO NOT LIKE THIS METHOD! IT NEEDS TCGA AND METABRIC FOR NOW... WE NEED TO THINK ABOUT SOMETHING BETTER

trained.model = train_and_test_model(Modules_training = BRCA.Modules.OE, Modules_training.metadata = prep_list_tcga_spongEffects$TCGA.meta.tumor, Modules_testing = METABRIC.Modules.OE, Modules_testing.metadata = prep_list_METABRIC_spongEffects$METABRIC.meta, Modules_testing.metadata.type ="METABRIC", core = 1)

```
## (J) 2. Train and test on Central Genes
```{r, warning=FALSE, message=FALSE}
central.genes.model = build_classifier_central_genes(expression.data.set1 = prep_list_tcga_spongEffects$TCGA.expr.tumor, expression.data.set2 = prep_list_METABRIC_spongEffects$METABRIC.expr, enrichment.modules.data.set1 = BRCA.Modules.OE, enrichment.modules.data.set2 = METABRIC.Modules.OE, meta.data.set1 = prep_list_tcga_spongEffects$TCGA.meta.tumor, meta.data.set2 = prep_list_METABRIC_spongEffects$METABRIC.meta, type.data.set1 = "TCGA", type.data.set2 = "METABRIC", Metric="Exact_match", n.folds=10)
```

## (J) 3. Randomly train and test
```{r, warning=FALSE, message=FALSE}
random.model = build_classifier_random(Sponge.modules= Sponge.modules,expression.data.set1 = prep_list_tcga_spongEffects$TCGA.expr.tumor, expression.data.set2 = prep_list_METABRIC_spongEffects$METABRIC.expr, meta.data.set1 = prep_list_tcga_spongEffects$TCGA.meta.tumor, meta.data.set2 = prep_list_METABRIC_spongEffects$METABRIC.meta, type.data.set1 = "TCGA", type.data.set2 = "METABRIC", Metric="Exact_match", n.folds=10)
```

## (K) Plot top k modules
```{r, warning=FALSE, message=FALSE}
lollipop_plot=plot_top_modules(trained.model=trained.model)
```


## (L) Density of module scores
```{r, warning=FALSE, message=FALSE}
density_plot_TCGA=plot_density_scores(trained.model=trained.model,modules = BRCA.Modules.OE,meta_data =prep_list_tcga_spongEffects$TCGA.meta.tumor,data_type="TCGA",subtypes = tcga_subtypes)
density_plot_METABRIC=plot_density_scores(trained.model=trained.model,modules = METABRIC.Modules.OE, meta_data = prep_list_METABRIC_spongEffects$METABRIC.meta,data_type = "METABRIC",subtypes = tcga_subtypes)
```

## (M) plot accuracy, sensitiviy, and specificity
```{r, warning=FALSE, message=FALSE}
metric_plot_list<-plot_accuracy_sensitivity_specificity(trained.model = trained.model,CentralGenes.model = central.genes.model,Random.model = random.model,training_dataset_name = "TCGA",testing_dataset_name = "METABRIC",subtypes = tcga_subtypes)

```

## (N) plot confusion matrices
```{r, warning=FALSE, message=FALSE}

subtypes.testing.factors <-prep_list_METABRIC_spongEffects$METABRIC.meta$CLAUDIN_SUBTYPE[complete.cases(t(METABRIC.Modules.OE))]

conf_matrix_trained<-plot_confusion_matrices(trained.model = trained.model, subtypes.testing.factors = subtypes.testing.factors)
conf_matrix_random<-plot_confusion_matrices(trained.model = random.model,subtypes.testing.factors = subtypes.testing.factors)
```

## (O) plot module heatmaps
## TODO: METABRIC NOT WORKING! HAVE TO FIND BUG
```{r, warning=FALSE, message=FALSE}

tcga.heatmap<-plot_heatmaps_training_test(trained.model = trained.model, Sponge.modules = Sponge.modules,enrichment.modules = BRCA.Modules.OE, meta.data = prep_list_tcga_spongEffects$TCGA.meta.tumor,type.data.set = "TCGA",subtypes = tcga_subtypes)
#metabric.heatmap<-plot_heatmaps_training_test(trained.model = trained.model, Sponge.modules = Sponge.modules,enrichment.modules = METABRIC.Modules.OE, meta.data = prep_list_METABRIC_spongEffects$METABRIC.meta, type.data.set = "METABRIC",subtypes = tcga_subtypes)

```

## (P) plot miRNA to modules heatmap
```{r, warning=FALSE, message=FALSE}
plot_involved_miRNAs_to_modules(Sponge.modules = Sponge.modules, trained.model = trained.model,dir_miRNAs_significance = "/nfs/data/SPONGE/results/breast invasive carcinoma_mirna_targets_all_mirs.RData")
```

## (Q) stop the cluster for parallelization
```{r, warning=FALSE, message=FALSE}
stopCluster(cl) 
```